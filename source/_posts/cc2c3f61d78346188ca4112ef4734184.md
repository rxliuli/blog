---
layout: post
title: åœ¨ Chrome æ’ä»¶ä¸­å°† ArrayBuffer ä»ç½‘é¡µä¼ é€’åˆ° Devtools Panel
abbrlink: cc2c3f61d78346188ca4112ef4734184
tags:
  - chrome extension
  - å·¥å…·
  - typescript
categories:
  - å‰ç«¯
  - Web API
date: 1731437521870
updated: 1732307244435
---

## èƒŒæ™¯

æœ€è¿‘ä½¿ç”¨äº† ZenFS åœ¨æµè§ˆå™¨ä¸­æ¨¡æ‹Ÿæ–‡ä»¶ç³»ç»Ÿï¼Œä»¥åœ¨æµè§ˆå™¨ä¸­åƒä½¿ç”¨ node fs api ä¸€æ ·å­˜å‚¨ä¸€äº›æ–‡ä»¶ã€‚ä½†æƒ³è¦å¯è§†åŒ–çš„æ£€æŸ¥å½“å‰å­˜å‚¨çš„æ–‡ä»¶æ—¶ï¼Œå´æ²¡æœ‰ä¸€ä¸ªå¯ä»¥ç›´è§‚çš„å·¥å…·æ¥å®Œæˆã€‚æ‰€ä»¥å°±åˆ›å»ºäº†ä¸€ä¸ª Chrome Devtools Extension [ZenFS Viewer](https://chromewebstore.google.com/detail/zenfs-viewer/mdbgdjlikgdjeandfkabaleddcpaigkk)ï¼Œä»¥å®ç°è¿™ä¸ªç›®æ ‡ã€‚åœ¨æ­¤è¿‡ç¨‹ä¸­å°±é‡åˆ°äº†å¦‚ä½•ä¼ é€’ ArrayBuffer ä»ç½‘é¡µåˆ° devtools panel çº¿ç¨‹çš„é—®é¢˜ï¼Œä¸€äº›å°è¯•å¦‚ä¸‹ã€‚

### browser.devtools.inspectedWindow\.eval

é¦–å…ˆå°è¯•äº†æœ€ç®€å•çš„æ–¹æ³•ï¼Œ`browser.devtools.inspectedWindow.eval` å¯ä»¥åœ¨ç½‘é¡µæ‰§è¡Œä»»æ„ä»£ç å¹¶å¾—åˆ°ç»“æœï¼Œä¾‹å¦‚

```ts
browser.devtools.inspectedWindow.eval(`__zenfs__.readdir('/')`)
```

ç„¶è€Œ inspectedWindow\.eval å¹¶ä¸æ”¯æŒ Promise è¿”å›å€¼ï¼Œä¾‹å¦‚ä¸‹é¢çš„è¡¨è¾¾å¼æ— æ³•å¾—åˆ° Promise ç»“æœ

```ts
browser.devtools.inspectedWindow.eval(`await __zenfs__.promises.readdir('/')`)
```

åŒæ ·çš„ï¼Œä¹Ÿæ— æ³•æ”¯æŒ ArrayBufferã€‚æ‰€ä»¥è¿™ä¸ªæ˜¾è€Œæ˜“è§çš„ API è¢«æ”¾å¼ƒäº†ã€‚

```ts
browser.devtools.inspectedWindow.eval(
  `await __zenfs__.promises.readFile('/test.png')`,
)
```

### chrome.runtime.sendMessage

æ¥ä¸‹æ¥å°±æ˜¯æ€æƒ³ä½“æ“çš„æ—¶å€™äº†ï¼Œä¸€å¼€å§‹è€ƒè™‘çš„æ–¹æ¡ˆå°±æ˜¯é€šè¿‡ devtools panel => background script => content-script(isolation) => content-script(main) è¿›è¡Œä¸­è½¬é€šä¿¡ï¼Œä»¥æ­¤åœ¨ devtools panel ä¸­è°ƒç”¨ç½‘é¡µçš„å…¨å±€å˜é‡å¹¶ä¼ é€’å’Œè·å– ArrayBuffer çš„å“åº”ã€‚å¤§æ¦‚ç¤ºæ„å›¾å¦‚ä¸‹

![before.excalidraw.svg](/resources/0574c9d552564681aead7e23d40f535d.svg)

ç„¶è€Œåœ¨ä½¿ç”¨ `chrome.runtime.sendMessage` æ—¶ä¹Ÿé‡åˆ°äº†å’Œ `inspectedWindow.eval` ç±»ä¼¼çš„é—®é¢˜ï¼Œæ— æ³•ä¼ é€’ ArrayBufferï¼Œä»…æ”¯æŒ JSON Valueã€‚å½“ç„¶å¯ä»¥åºåˆ—åŒ– ArrayBuffer ä¸º JSONï¼Œä½†åœ¨ä¼ è¾“è§†é¢‘ä¹‹ç±»çš„å¤§å‹æ•°æ®æ—¶å¹¶ä¸ç°å®ã€‚

## è§£å†³

ä¹‹åç»è¿‡ä¸€äº›æœç´¢å’Œæ€è€ƒï¼Œæ‰¾åˆ°äº†ä¸€ç§æ–¹æ³•å¯ä»¥ç»•é“ chrome.runtime.messageï¼Œå› ä¸ºæ³¨å…¥çš„ iframe å’Œ devtools panel åŒæºï¼Œæ‰€ä»¥å¯ä»¥ä½¿ç”¨ BroadcastChannel é€šä¿¡ï¼Œè€Œ iframe å’Œæ³¨å…¥çš„ content-script(main world) ä¹‹é—´å°½ç®¡ä¸åŒæºï¼Œä½†ä»ç„¶å¯ä»¥é€šè¿‡ postMessage/onMessage æ¥é€šä¿¡ï¼Œå¹¶ä¸”ä¸¤è€…éƒ½æ”¯æŒä¼ é€’ ArrayBufferï¼Œè¿™æ ·ä¾¿å¯ç»•é“æˆåŠŸã€‚

![after.excalidraw.svg](/resources/3cc8d08628e94e59a7a2ab60a0c7dfe8.svg)

## Content-Script <=> Iframe

ç½‘é¡µä¸æ³¨å…¥çš„ iframe ä¹‹é—´ï¼Œé€šä¿¡å¯ä»¥ä½¿ç”¨åŸºæœ¬çš„ postMessage/onMessage å®ç°ï¼Œä¸ºäº†å‡å°‘å†—ä½™ä»£ç ï¼Œè¿™é‡Œä½¿ç”¨ [comlink](https://github.com/GoogleChromeLabs/comlink) æ¥å®ç°ã€‚

å…ˆçœ‹çœ‹æ³¨å…¥çš„ content-scriptï¼Œå®ƒä¸»è¦æ˜¯è´Ÿè´£å¯¹ iframe æš´éœ²ä¸€äº› API çš„ã€‚

```ts
// entrypoints/main-content.ts
import { expose, windowEndpoint } from 'comlink'

export default defineUnlistedScript(() => {
  const map = new Map<string, ArrayBuffer>()

  interface IFS {
    readFile: (path: string) => Promise<ArrayBuffer>
    writeFile: (path: string, data: ArrayBuffer) => Promise<void>
    readdir: (path: string) => Promise<string[]>
  }

  expose(
    {
      readFile: async (path: string) => {
        return map.get(path) || new Uint8Array([1, 2, 3]).buffer
      },
      writeFile: async (path: string, data: ArrayBuffer) => {
        map.set(path, data)
      },
      readdir: async (path: string) => {
        return Array.from(map.keys()).filter((p) => p.startsWith(path))
      },
    } as IFS,
    windowEndpoint(
      (document.querySelector('#inject-iframe')! as HTMLIFrameElement)
        .contentWindow!,
    ),
  )
  console.log('main-content')
})
```

è€Œåœ¨ iframe ä¸­ï¼Œåˆ™éœ€è¦è½¬å‘æ‰€æœ‰æ¥è‡ª BroadcastChannel çš„è¯·æ±‚é€šè¿‡ postMessage ä¼ é€’åˆ°ä¸Šå±‚æ³¨å…¥çš„ content-script ä¸­ï¼Œå…¶ä¸­åœ¨æ¯æ¬¡ä¼ é€’ ArrayBuffer æ—¶éƒ½éœ€è¦ä½¿ç”¨ transfer æ¥è½¬ç§»å¯¹è±¡åˆ°ä¸åŒçº¿ç¨‹ã€‚

```ts
// entrypoints/iframe/main.ts
import { expose, transfer, windowEndpoint, wrap } from 'comlink'

interface IFS {
  readFile: (path: string) => Promise<ArrayBuffer>
  writeFile: (path: string, data: ArrayBuffer) => Promise<void>
  readdir: (path: string) => Promise<string[]>
}

async function main() {
  const tabId = (await browser.tabs.getCurrent())!.id
  if (!tabId) {
    return
  }
  const ipc = wrap<IFS>(windowEndpoint(globalThis.parent))
  const bc = new BroadcastChannel(
    `${browser.runtime.getManifest().name}-iframe-${tabId}`,
  )
  expose(
    {
      readFile: async (path: string) => {
        const r = await ipc.readFile(path)
        // å°† ArrayBuffer é€šè¿‡ transfer ä¼ é€’å› devtools-panel ä¸­
        return transfer(r, [r])
      },
      writeFile: async (path: string, data: ArrayBuffer) => {
        // å°† ArrayBuffer é€šè¿‡ transfer ä¼ é€’åˆ° content-script ä¸­
        await ipc.writeFile(path, transfer(data, [data]))
      },
      readdir: async (path: string) => {
        console.log('readdir', path)
        return await ipc.readdir(path)
      },
    } as IFS,
    bc,
  )

  console.log('iframe main')
}

main()
```

## Iframe <=> Devtools

è€Œåœ¨ Devtools ä¸­ï¼Œè¦åšçš„äº‹æƒ…æœ‰ä¸€ç‚¹ç‚¹å¤š ğŸ¤ã€‚é¦–å…ˆéœ€è¦æ³¨å…¥ä¸¤ä¸ª content-scriptï¼Œè€Œå…¶ä¸­ isolation-content.js æ˜¯ç”¨æ¥åˆ›å»º iframe çš„ content-scriptã€‚

```ts
// entrypoints/devtools-panel/main.ts
import { PublicPath } from 'wxt/browser'

async function injectScript() {
  const includeIframe = await new Promise((resolve) => {
    browser.devtools.inspectedWindow.eval(
      `!!document.querySelector('#inject-iframe')`,
      (result) => {
        resolve(result)
      },
    )
  })
  if (includeIframe) {
    return
  }
  const tabId = browser.devtools.inspectedWindow.tabId
  if (!tabId) {
    return
  }
  await browser.scripting.executeScript({
    target: { tabId },
    files: ['/isolation-content.js' as PublicPath],
    world: 'ISOLATED',
  })
  await browser.scripting.executeScript({
    target: { tabId },
    files: ['/main-content.js' as PublicPath],
    world: 'MAIN',
  })
}
```

```ts
// entrypoints/isolation-content.ts
function createIframeUi() {
  const wrapper = document.createElement('div')
  wrapper.style.height = '0'
  wrapper.style.width = '0'
  const ifr = document.createElement('iframe')
  wrapper.appendChild(ifr)
  ifr.src = browser.runtime.getURL('/iframe.html')
  ifr.style.width = '0'
  ifr.style.height = '0'
  ifr.style.zIndex = '-9999'
  ifr.style.border = 'none'
  ifr.id = 'inject-iframe'
  document.body.appendChild(wrapper)
  return ifr
}

export default defineUnlistedScript(() => {
  console.log('isolation-content', createIframeUi())
})
```

æ¥ä¸‹æ¥å°±å¯ä»¥åœ¨ devtools-panel ä¸­è·å–æ•°æ®äº†ï¼Œç”±äº iframe çš„æ³¨å…¥å®Œæˆçš„æ—¶æœºå¹¶ä¸èƒ½ç¡®å®šï¼Œæ‰€ä»¥éœ€è¦åŠ ä¸ªç®€å•çš„é€šçŸ¥æœºåˆ¶ã€‚

```ts
// entrypoints/iframe/main.ts
import { wrap } from 'comlink'

async function main() {
  // Other code...
  console.log('iframe main')
  await wrap<{
    onReady: () => void
  }>(bc).onReady()
}

main()
```

```ts
// entrypoints/devtools-panel/main.ts
async function main() {
  await injectScript()
  interface IFS {
    readFile: (path: string) => Promise<ArrayBuffer>
    writeFile: (path: string, data: ArrayBuffer) => Promise<void>
    readdir: (path: string) => Promise<string[]>
  }
  const tabId = browser.devtools.inspectedWindow.tabId
  if (!tabId) {
    return
  }
  const bc = new BroadcastChannel(
    `${browser.runtime.getManifest().name}-iframe-${tabId}`,
  )
  await new Promise<void>((resolve) => expose({ onReady: resolve }, bc))
  console.log('onReady')
  // Test code...
  const ipc = wrap<IFS>(bc)
  const r = await ipc.readdir('/')
  console.log(r)
  const data = new Uint8Array([1, 2, 3]).buffer
  await ipc.writeFile('/test.txt', transfer(data, [data]))
  const r2 = await ipc.readFile('/test.txt')
  console.log(r2)
}

main()
```

> å®Œæ•´ä»£ç å‚è€ƒ: <https://github.com/rxliuli/devtools-webpage-message-demo>

## æ€»ç»“

è‡³ä»Šä¸ºæ­¢ï¼Œä»ç„¶æ²¡æœ‰ç®€å•çš„æ–¹æ³•æ¥æ”¯æŒ Devtools Extension ä¸ Webpage ä¹‹é—´çš„é€šä¿¡æ¥æ›¿ä»£ `inspectedWindow.eval`ï¼Œç¡®å®æ˜¯æœ‰ç‚¹ç¥å¥‡ã€‚
