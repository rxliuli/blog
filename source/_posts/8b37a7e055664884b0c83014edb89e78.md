---
layout: post
title: Cloudflare D1 æ•°æ®åº“æŸ¥è¯¢ä¼˜åŒ–ä¹‹è·¯
abbrlink: 8b37a7e055664884b0c83014edb89e78
tags:
  - sql
  - æ€§èƒ½
categories:
  - å‰ç«¯
  - nodejs æœåŠ¡ç«¯
date: 1743666994544
updated: 1743678521322
---

## èƒŒæ™¯

æœ€è¿‘åœ¨åšä¸€äº›æœåŠ¡ç«¯ç›¸å…³çš„äº‹æƒ…ï¼Œä½¿ç”¨äº† Cloudflare Workers + D1 æ•°æ®åº“ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œé‡åˆ°äº†ä¸€äº›æ•°æ®åº“ç›¸å…³çš„é—®é¢˜ï¼Œè€Œå¯¹äºå‰ç«¯è€Œè¨€æ•°æ®åº“æ˜¯ä¸€ä»¶ç›¸å½“ä¸åŒçš„äº‹æƒ…ï¼Œæ‰€ä»¥åœ¨æ­¤è®°å½•ä¸€ä¸‹ã€‚

ä¸‹å›¾æ˜¯æœ€è¿‘ 30 å¤©çš„è¯·æ±‚è®°å½•ï¼Œå¯ä»¥çœ‹åˆ°æ•°æ®åº“æŸ¥è¯¢å˜åŒ–ä¹‹å‰§çƒˆã€‚

![1743670296635.jpg](/resources/3193aaf2c2b9479dacf34e3902af5aee.jpg)

## å‘ç°é—®é¢˜

è§£å†³é—®é¢˜çš„å‰ææ˜¯å‘ç°é—®é¢˜ï¼Œæœ‰å‡ ä¸ªæ–¹æ³•å¯ä»¥æ›´å®¹æ˜“ç•™æ„åˆ°ç›¸å…³é—®é¢˜ã€‚

1. æ£€æŸ¥ D1 ä»ªè¡¨ç›˜ï¼Œç¡®å®šæ•°æ®åº“æ“ä½œæ˜¯å¦æœ‰å¼‚å¸¸å¢é•¿
2. æ£€æŸ¥æŸ¥è¯¢è¯­å¥åŠè¯»å–/å†™å…¥è¡Œæ•°ï¼Œç‰¹åˆ«å…³æ³¨ count/rows read/rows written æ’åœ¨å‰åˆ—çš„æŸ¥è¯¢
3. ä½¿ç”¨ `c.env.DB.prepare('<sql>').run()).meta` å¹¶æ£€æŸ¥è¿”å›çš„ metaï¼Œå®ƒåŒ…å«è¿™ä¸ª sql å®é™…è¯»å–/å†™å…¥çš„è¡Œæ•°

## ä½¿ç”¨ batch æ‰¹é‡è¯·æ±‚

é¦–å…ˆæ˜ç¡®ä¸€ç‚¹ï¼ŒWorkers å’Œ D1 è™½ç„¶åŒä¸º Cloudflare çš„æœåŠ¡ï¼Œä½†åŒæ—¶ä½¿ç”¨å®ƒä»¬å¹¶ä¸ä¼šè®© D1 å˜å¾—æ›´å¿«ã€‚æ‹¿ä¸‹é¢è¿™ä¸ªç®€å•çš„æŸ¥è¯¢ä¸¾ä¾‹ï¼Œå®ƒçš„å¹³å‡å“åº”æ—¶é—´ï¼ˆåœ¨ Workers ä¸Šå‘èµ·æŸ¥è¯¢åˆ°åœ¨ Workers ä¸Šå¾—åˆ°ç»“æœï¼‰è¶…è¿‡äº† 200msã€‚

```ts
await db.select().from(user).limit(1)
```

æ‰€ä»¥åœ¨ä¸€ä¸ªæ¥å£ä¸­åŒ…å«å¤§é‡çš„æ•°æ®åº“æ“ä½œæ—¶ï¼Œåº”è¯¥å°½é‡ä½¿ç”¨ d1 batch æ¥æ‰¹é‡å®Œæˆï¼Œå°¤å…¶æ˜¯å¯¹äºå†™å…¥æ“ä½œï¼Œç”±äºæ²¡æœ‰åªè¯»å‰¯æœ¬ï¼Œå®ƒåªä¼šæ¯”æŸ¥è¯¢**æ›´æ…¢**ã€‚ä¾‹å¦‚

```ts
await db.insert(user).values({...})
await db.insert(tweet).values({...})
```

åº”è¯¥æ›´æ¢ä¸º

```ts
await db.batch([
  db.insert(user).values({...}),
  db.insert(tweet).values({...})
])
```

è¿™æ ·åªä¼šå‘ d1 å‘å‡ºä¸€æ¬¡ rest è¯·æ±‚å³å¯å®Œæˆå¤šä¸ªæ•°æ®åº“å†™å…¥æ“ä½œã€‚

> ps1: prisma ä¸æ”¯æŒ d1 batchï¼Œå¾è¾ˆå› æ­¤æ¢åˆ°äº† drizzle ä¸­ï¼Œå‚è€ƒ [è®°å½•ä¸€æ¬¡ä» Prisma åˆ° Drizzle çš„è¿ç§»](/p/4140cb8be8b044a5bb9cebe0930e3a4a)ã€‚
> ps2: ä½¿ç”¨ batch è¿›è¡Œæ‰¹é‡æŸ¥è¯¢æ—¶éœ€è¦å°å¿ƒï¼Œå°¤å…¶æ˜¯å¤šè¡¨æœ‰åŒåçš„åˆ—æ—¶ï¼Œå‚è€ƒ <https://github.com/drizzle-team/drizzle-orm/issues/555>

## update æ“ä½œæ’é™¤ id

åœ¨ update æ—¶åº”è¯¥æ’é™¤ idï¼ˆå³ä½¿å®é™…ä¸Šæ²¡æœ‰ä¿®æ”¹ï¼‰ã€‚ä¾‹å¦‚ä¸‹é¢çš„ä»£ç ï¼Œå°†å¤–éƒ¨ä¼ å…¥çš„ user ä¼ å…¥å¹¶æ›´æ–°ï¼Œçœ‹èµ·æ¥æ²¡é—®é¢˜ï¼Ÿ

```ts
await db.update(user).set(userParam).where(eq(user.id, userParam.id))
```

å®é™…æ‰§è¡Œçš„ SQL è¯­å¥

```sql
update "User" set "id" = ?, "screenName" = ?, "updatedAt" = ? where "User"."id" = ?
```

ç„¶è€Œï¼Œä¸€æ—¦è¿™ä¸ª id è¢«å…¶ä»–è¡¨é€šè¿‡å¤–é”®å¼•ç”¨äº†ã€‚å®ƒå°±ä¼šå¯¼è‡´å¤§é‡çš„ rows read æ“ä½œã€‚ä¾‹å¦‚å¦ä¸€å¼ åä¸º tweet çš„è¡¨æœ‰ä¸€ä¸ª userId å¼•ç”¨äº†è¿™ä¸ªå­—æ®µï¼Œå¹¶ä¸”æœ‰ 1000 è¡Œæ•°æ®ã€‚

```ts
await db.batch([
  db.insert(user).values({
    id: `test-user-1`,
    screenName: `test-screen-name-1`,
    name: `test-name-1`,
  }),
  ...range(1000).map((it) =>
    db.insert(tweet).values({
      id: `test-tweet-${it}`,
      userId: `test-user-1`,
      text: `test-text-${it}`,
      publishedAt: new Date().toISOString(),
    }),
  ),
] as any)
```

ç„¶åè¿›è¡Œä¸€æ¬¡ update æ“ä½œå¹¶æ£€æŸ¥å®é™…æ“ä½œå½±å“çš„è¡Œæ•°

```ts
const userParam: InferInsertModel<typeof user> = {
  id: 'test-user-1',
  screenName: 'test',
}
const r = await db.update(user).set(userParam).where(eq(user.id, userParam.id))
console.log(r.meta)

// {
//   served_by: 'miniflare.db',
//   duration: 1,
//   changes: 1,
//   last_row_id: 1000,
//   changed_db: true,
//   size_after: 364544,
//   rows_read: 2005,
//   rows_written: 3
// }
```

å¯ä»¥çœ‹åˆ° rows read çªç„¶å¢é«˜åˆ°äº† 2005ï¼Œè€Œé¢„æœŸåº”è¯¥æ˜¯ 1ï¼Œè€ƒè™‘ä¸€ä¸‹å…³è”çš„è¡¨å¯èƒ½æœ‰æ•°ç™¾ä¸‡è¡Œæ•°æ®ï¼Œè¿™æ˜¯ä¸€åœºå™©æ¢¦ã€‚è€Œå¦‚æœç¡®å®æ’é™¤äº† id å­—æ®µï¼Œåˆ™å¯ä»¥çœ‹åˆ° rows read/rows written ç¡®å®æ˜¯é¢„æœŸçš„ 1ï¼Œæ— è®ºå®ƒå…³è”äº†å¤šå°‘æ•°æ®ã€‚

```ts
const r = await db
  .update(user)
  .set(omit(userParam, ['id']))
  .where(eq(user.id, userParam.id))
console.log(r.meta)

// {
//   served_by: 'miniflare.db',
//   duration: 0,
//   changes: 1,
//   last_row_id: 1000,
//   changed_db: true,
//   size_after: 364544,
//   rows_read: 1,
//   rows_written: 1
// }
```

> å¯ä»¥è¯´è¿™æ˜¯ä¸ªå…¸å‹çš„æ„šè ¢é”™è¯¯ï¼Œä½†å‰ç«¯ç¡®å®å¯¹æ•°æ®åº“é—®é¢˜ä¸å¤Ÿæ•é”ã€‚

## é¿å… count æ‰«æå…¨è¡¨

å¾è¾ˆåœ¨ D1 ä»ªè¡¨ç›˜ä¸­çœ‹åˆ°äº†ä¸‹é¢è¿™ä¸ª SQL è¯­å¥åœ¨ rows read ä¸­ååˆ—å‰çŸ›ã€‚åƒæ˜¯ä¸‹é¢è¿™æ ·

```sql
SELECT count(id) as num_rows FROM "User";
```

å¯èƒ½ä¼šåœ¨ä»ªè¡¨ç›˜çœ‹åˆ° rows read çš„æš´å¢ã€‚

![1743677991276.jpg](/resources/50bd12373d734ae285c011eb076e808d.jpg)

è¿™å¯¼è‡´äº†å¾è¾ˆåœ¨å®ç°åˆ†é¡µæ—¶ç›´æ¥é€‰æ‹©äº†åŸºäº cursor è€Œé offsetï¼Œè€Œä¸”æ°¸è¿œä¸ä¼šç»™å‡ºæ€»æ•°ï¼Œå› ä¸ºå³ä¾¿ id æœ‰ç´¢å¼•ï¼Œç»Ÿè®¡æ•°é‡ä¹Ÿä¼šæ‰«ææ‰€æœ‰è¡Œã€‚è¿™ä¹Ÿæ˜¯ä¸€ä¸ªå·²çŸ¥é—®é¢˜ï¼š<https://community.cloudflare.com/t/full-scan-for-simple-count-query/682625>

## é¿å…å¤šè¡¨ leftJoin

èµ·å› æ˜¯å¾è¾ˆæ³¨æ„åˆ°ä¸‹é¢è¿™æ¡ sql å¯¼è‡´äº†æ•°åä¸‡çš„ rows readã€‚

```sql
SELECT "modlist"."id",
       "modlist"."updatedat",
       "modlistsubscription"."action",
       Json_group_array(DISTINCT "modlistuser"."twitteruserid"),
       Json_group_array(DISTINCT "modlistrule"."rule")
FROM   "modlist"
       LEFT JOIN "modlistsubscription"
              ON "modlist"."id" = "modlistsubscription"."modlistid"
       LEFT JOIN "modlistuser"
              ON "modlist"."id" = "modlistuser"."modlistid"
       LEFT JOIN "modlistrule"
              ON "modlist"."id" = "modlistrule"."modlistid"
WHERE  "modlist"."id" IN ( ?, ? )
GROUP  BY "modlist"."id",
          "modlistsubscription"."action";
```

ä¸‹é¢æ˜¯å¯¹åº”çš„ ts ä»£ç 

```ts
await db
  .select({
    modListId: modList.id,
    updatedAt: modList.updatedAt,
    action: modListSubscription.action,
    modListUsers: sql<string>`json_group_array(DISTINCT ${modListUser.twitterUserId})`,
    modListRules: sql<string>`json_group_array(DISTINCT ${modListRule.rule})`,
  })
  .from(modList)
  .leftJoin(modListSubscription, eq(modList.id, modListSubscription.modListId))
  .leftJoin(modListUser, eq(modList.id, modListUser.modListId))
  .leftJoin(modListRule, eq(modList.id, modListRule.modListId))
  .where(inArray(modList.id, queryIds))
  .groupBy(modList.id, modListSubscription.action)
```

å¯ä»¥çœ‹åˆ°è¿™é‡Œè¿æ¥äº† 4 å¼ è¡¨æŸ¥è¯¢ï¼Œè¿™ç§æ„šè ¢çš„æ“ä½œå¾è¾ˆä¸çŸ¥é“å½“æ—¶æ˜¯æ€ä¹ˆå†™å‡ºæ¥çš„ï¼Œä¹Ÿè®¸æ˜¯ LLM å‘Šè¯‰å¾è¾ˆçš„ ğŸ˜‚ã€‚è€Œå¾è¾ˆå¹¶æœªæ„è¯†åˆ°è¿™ç§æ“ä½œå¯èƒ½ä¼šå¯¼è‡´æ‰€è°“çš„â€œç¬›å¡å°”ç§¯çˆ†ç‚¸â€[^1]ï¼Œå¿…é¡»è¿›è¡Œä¸€äº›æ‹†åˆ†ã€‚

â€œç¬›å¡å°”ç§¯çˆ†ç‚¸â€æ˜¯ä»€ä¹ˆï¼Ÿåœ¨è¿™ä¸ªåœºæ™¯ä¸‹å°±å¾è¾ˆçš„ç†è§£è€Œè¨€ï¼Œå¦‚æœä½¿ç”¨ leftJoin å¤–è¿å¤šå¼ è¡¨ï¼Œå¹¶ä¸”å¤–è”çš„å­—æ®µç›¸åŒï¼Œé‚£ä¹ˆå°±æ˜¯å¤šå¼ è¡¨æŸ¥è¯¢åˆ°çš„æ•°æ®ä¹‹å’Œã€‚ä¾‹å¦‚ä¸‹é¢è¿™æ¡æŸ¥è¯¢ï¼Œå¦‚æœ modListUser/modListRule éƒ½æœ‰ 100 æ¡æ•°æ®ï¼Œé‚£ä¹ˆæŸ¥è¯¢çš„ç»“æœåˆ™æœ‰ 100 \* 100 æ¡ç»“æœï¼Œè¿™å¹¶ä¸ç¬¦åˆé¢„æœŸã€‚

```ts
db.select()
  .from(modList)
  .leftJoin(modListUser, eq(modList.id, modListUser.modListId))
  .leftJoin(modListRule, eq(modList.id, modListRule.modListId))
  .where(eq(modList.id, 'modlist-1')) // 10101 rows read
```

è€Œå¦‚æœæ­£ç¡®çš„æ‹†åˆ†æŸ¥è¯¢å¹¶å°†æ•°æ®åˆ†ç»„å’Œè½¬æ¢æ”¾åˆ°é€»è¾‘å±‚ï¼Œæ•°æ®åº“çš„æ“ä½œå°±ä¼šå¤§å¤§å‡å°‘ã€‚

```ts
await db.batch([
  db
    .select({
      modListId: modListUser.modListId,
      twitterUserId: modListUser.twitterUserId,
    })
    .from(modListUser)
    .where(eq(modListUser.modListId, 'modlist-1')),
  db
    .select({
      modListId: modListRule.modListId,
      rule: modListRule.rule,
    })
    .from(modListRule)
    .where(eq(modListRule.modListId, 'modlist-1')),
]) // 200 rows read
```

[^1]: <https://learn.microsoft.com/ef/core/querying/single-split-queries>

## insert values å†™å…¥å¤šæ¡æ•°æ®

> å¦‚æœ rows written æ•°é‡ä¸å¤šï¼Œæˆ–è€…æ²¡æœ‰æ‰¹å¤„ç†çš„éœ€æ±‚ï¼Œé‚£è¿™å¯èƒ½åªæ˜¯è¿‡æ—©ä¼˜åŒ–ã€‚

è¿™æ˜¯åœ¨ä¼˜åŒ–å†™å…¥æ€§èƒ½æ—¶å°è¯•çš„ä¸€ä¸ªå°æŠ€å·§ï¼Œå¯ä»¥æå‡æ‰¹é‡å†™å…¥çš„æ€§èƒ½ã€‚è€ƒè™‘ä¸‹é¢è¿™ä¸ªæ‰¹é‡æ’å…¥çš„ä»£ç 

```ts
await Promise.all(users.map((it) => db.insert(user).values(it)) as any)
```

å—¯ï¼Œè¿™åªæ˜¯ä¸ªæ„šè ¢çš„ä¾‹å­ï¼Œå½“ç„¶è¦ä½¿ç”¨ batch æ“ä½œï¼Œå°±åƒä¸Šé¢è¯´çš„é‚£æ ·ã€‚

```ts
await db.batch(users.map((it) => db.insert(user).values(it)) as any)
```

ä½†æ˜¯å¦å¿˜è®°äº†ä»€ä¹ˆï¼Ÿæ˜¯çš„ï¼Œæ•°æ®åº“å…è®¸åœ¨ä¸€è¡Œä¸­å†™å…¥å¤šæ¡æ•°æ®ï¼Œä¾‹å¦‚ï¼š

```ts
await db.insert(user).values(users)
```

ä¸å¹¸çš„æ˜¯ï¼Œsqlite å…è®¸ç»‘å®šçš„å‚æ•°æ•°é‡æœ‰é™ï¼ŒD1 è¿›ä¸€æ­¥é™åˆ¶äº†å®ƒ [^2]ï¼Œæ¯æ¬¡å‚æ•°ç»‘å®šæœ€å¤šåªæœ‰ 100 ä¸ªã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬æœ‰ 10 åˆ—ï¼Œæˆ‘ä»¬æœ€å¤šåœ¨ä¸€æ¡ SQL ä¸­æ’å…¥ 10 è¡Œï¼Œå¦‚æœæ‰¹å¤„ç†æ•°é‡å¾ˆå¤šï¼Œä»ç„¶éœ€è¦æ”¾åœ¨ batch ä¸­å¤„ç†ã€‚
å¹¸è¿çš„æ˜¯ï¼Œå®ç°ä¸€ä¸ªé€šç”¨çš„è‡ªåŠ¨åˆ†é¡µå™¨å¹¶ä¸éº»çƒ¦ï¼Œå‚è€ƒ <https://github.com/drizzle-team/drizzle-orm/issues/2479#issuecomment-2746057769>

```ts
await db.batch(
  safeChunkInsertValues(user, users).map((it) =>
    db.insert(user).values(it),
  ) as any,
)
```

é‚£ä¹ˆï¼Œæˆ‘ä»¬å®é™…è·å¾—æ€§èƒ½æ”¶ç›Šæ˜¯å¤šå°‘ï¼Ÿ

å°±ä¸Šé¢ä¸¾çš„ 3 ä¸ªä¾‹å­è¿›è¡Œäº†æµ‹è¯•ï¼Œæ¯ä¸ªä¾‹å­åˆ†åˆ«æ’å…¥ 5000 æ¡æ•°æ®ï¼Œå®ƒä»¬åœ¨æ•°æ®åº“æ‰§è¡ŒèŠ±è´¹çš„æ—¶é—´æ˜¯

78ms => 37ms => 14ms

å¾è¾ˆè®¤ä¸ºè¿™ä¸ªä¼˜åŒ–è¿˜æ˜¯å€¼å¾—åšçš„ï¼Œå°è£…ä¹‹åå®ƒå¯¹ä»£ç å‡ ä¹æ˜¯æ— ä¾µå…¥çš„ã€‚

[^2]: <https://developers.cloudflare.com/d1/platform/limits/#:~:text=Maximum%20number%20of%20columns%20per%20table>

## æ€»ç»“

æœåŠ¡ç«¯çš„é—®é¢˜ä¸å®¢æˆ·ç«¯ç›¸å½“ä¸åŒï¼Œåœ¨å®¢æˆ·ç«¯ï¼Œå³ä¾¿æŸä¸ªåŠŸèƒ½å‡ºç°äº†é”™è¯¯ï¼Œä¹Ÿåªæ˜¯å½±å“ä½¿ç”¨è€…ã€‚è€ŒæœåŠ¡ç«¯çš„é”™è¯¯å¯èƒ½ç›´æ¥å½±å“æœˆåº•è´¦å•ï¼Œè€Œä¸”éœ€è¦ä¸€æ®µæ—¶é—´æ‰èƒ½çœ‹å‡ºæ¥ï¼Œå› æ­¤éœ€è¦å°å¿ƒï¼Œæ·»åŠ è¶³å¤Ÿçš„å•å…ƒæµ‹è¯•ã€‚è§£å†³æ•°æ®åº“æŸ¥è¯¢ç›¸å…³çš„é—®é¢˜æ—¶ï¼Œå¾è¾ˆè®¤ä¸ºéµå¾ª **å‘ç° => è°ƒæŸ¥ => å°è¯•è§£å†³ => è·Ÿè¿› => å†æ¬¡å°è¯• => è·Ÿè¿› => å®Œæˆ** çš„æ­¥éª¤ä¼šæœ‰å¸®åŠ©ï¼Œç¬¬ä¸€æ¬¡è§£å†³å¹¶ä¸ä¸€å®šèƒ½å¤ŸæˆåŠŸï¼Œç”šè‡³æœ‰å¯èƒ½å˜çš„æ›´ç³Ÿï¼Œä½†æŒç»­çš„è·Ÿè¿›å°†ä½¿å¾—åŠæ—¶å‘ç°å’Œä¿®å¤é—®é¢˜å˜å¾—éå¸¸é‡è¦ã€‚
